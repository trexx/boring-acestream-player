FROM docker.io/library/bash:latest AS website

WORKDIR /app

COPY ./player /app/player

RUN apk add gzip
RUN /usr/bin/env bash -O globstar -c 'gzip -9 /app/**/*.{html,js}'

# Build Busybox
FROM alpine:latest AS build-busybox
ENV BUSYBOX_VERSION="1.37.0"

RUN apk add gcc musl-dev make perl
RUN wget https://busybox.net/downloads/busybox-${BUSYBOX_VERSION}.tar.bz2 \
  && tar xf busybox-${BUSYBOX_VERSION}.tar.bz2 \
  && mv /busybox-${BUSYBOX_VERSION} /busybox

WORKDIR /busybox
COPY .config ./

RUN make && make install
RUN adduser -D static

# Download catatonit
# renovate: datasource=github-releases depName=openSUSE/catatonit
ENV CATATONIT_VERSION="v0.2.1"
ADD https://github.com/openSUSE/catatonit/releases/download/${CATATONIT_VERSION}/catatonit.x86_64 /catatonit
RUN chmod +x /catatonit

# Compile scratch image
FROM scratch AS compile
LABEL org.opencontainers.image.source="https://github.com/trexx/docker-ace-player"

COPY --from=build-busybox /etc/passwd /etc/passwd
COPY --from=build-busybox /busybox/_install/bin/busybox /
COPY --from=build-busybox /catatonit /

USER static
WORKDIR /www

COPY --from=website /app /www/

ENTRYPOINT ["/catatonit", "--"]
CMD ["/busybox", "httpd", "-f", "-p", "8080"]
